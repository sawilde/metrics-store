<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>
      Simple Chart Sample Using Data From Metrics-Store
    </title>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
	<script type="text/javascript">
      google.load('visualization', '1', {packages: ['corechart']});
    </script>
	<script>

    function drawVisualization(seqvalues, brvalues){
		  
	  var data = new google.visualization.DataTable();
      data.addColumn('date', 'Date');
      data.addColumn('number', 'Sequence Coverage');
      data.addColumn('number', 'Branch Coverage');
	  
	  var dates = [];
	  
	  for (var i=0; i < seqvalues.length; i++) {
	    var date = new Date(seqvalues[i].date);
		dates.push(date);
	    data.addRow([date, seqvalues[i].value, null]);
	  }
	  for (var i=0; i < brvalues.length; i++) {
	    var date = new Date(brvalues[i].date);
		dates.push(date);
	    data.addRow([date, null, brvalues[i].value]);
	  }
	  
	  var min = new Date(Math.min.apply(null, dates));
	  var max = new Date(Math.max.apply(null, dates));
	  
	  min.setDate(min.getDate()-1);
	  max.setDate(max.getDate()+1);
	  	  
	  visualization = new google.visualization.LineChart(document.getElementById('visualization'));
      visualization.draw(data, {curveType: "function",
	                    pointSize: 5,
                        width: 500, height: 400,
                        vAxis: {maxValue: 100, minValue: 0},
						hAxis: {viewWindowMode: 'explicit',
							viewWindow: {min: min,
										 max: max} }});
	}	
	
	function getDataAndVisualize(){
	    var jxhr = [];
		var seqvalues = [];
		var brvalues = [];
	
        jxhr.push(
		  $.getJSON('/metrics/opencover_release_sequence?callback=?', function(data) {
		    seqvalues = data.values;
		  }) 
		); 
		
        jxhr.push(
		  $.getJSON('/metrics/opencover_release_branch?callback=?', function(data) {
		    brvalues = data.values;
		  }) 
		); 
		
		$.when.apply($, jxhr).done(function() {
		  drawVisualization(seqvalues, brvalues);
		});
	}
	
	$( document ).ready( function() {
	  getDataAndVisualize();
    });

	</script>
	<body>
  	  <div id="visualization"></div>
	</body>	
</html>